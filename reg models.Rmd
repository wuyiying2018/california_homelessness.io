---
title: "reg models"
author: "Yiying Wu"
date: "2023-11-26"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
echo = TRUE,
warning = FALSE,
fig.width = 9, 
  fig.height = 9,
  out.width = "80%"
)

library(tidyverse)
library(corrplot)
library(MASS)
```

## Import Data & Recoding
First import data and create dummy variables for categorical variables.
```{r, message=FALSE}
dat <- read_csv("2019-2020-homeless-ip-and-ed-by-facility.csv")|>
  filter(HomelessIndicator == "Homeless") 

### EncounterType
dat$ed_visit <- ifelse(dat$EncounterType=="ED Visits",1,0)

### Ownership
dat$government <- ifelse(dat$Ownership=="Government",1,0)
dat$investor <- ifelse(dat$Ownership=="Investor",1,0)

### Urban_Rural
dat$rural <- ifelse(dat$Urban_Rural=="Rural/Frontier",1,0)

### LicensedBedSize
## the first level will be treated as ref
dat$LicensedBedSize <- as.factor(dat$LicensedBedSize)
dat$ordered_LicensedBedSize <- ordered(dat$LicensedBedSize, 
                             levels = c("1-99","100-199","200-299","300-399","400+"))
```
The variables and corresponding descriptions are as follows.

| Variable | Description | Value |
|-------|-----------|-----------|
| ed_visit | Dummy variable for EncounterType  | 1=ED Visits, 0=Inpatient Hospitalizations   |
| government | Dummy variable for Ownership | 1=Government, 0=Otherwise |
| investor | Dummy variable for Ownership | 1=Investor, 0=Otherwise |
| rural | Dummy variable for Urban_Rural | 1=Rural/Frontier, 0=Urban |

## Univariate Analysis
We conducted univariate analyses to identify individual factors associated with outcomes `Encounters`. 

```{r}
# Function to round all numeric columns in a dataframe
round_df <- function(df, digits) {
  df %>% mutate(across(where(is.numeric), ~ round(., digits)))
}

# Create tidied summaries for each model and round them
### EncounterType
tidy_ed_visit <- round_df(broom::tidy(lm(Encounters ~ ed_visit, data = dat)), 4) %>%
  mutate(Model = "EncounterType")

### Ownership
tidy_Ownership <- round_df(broom::tidy(lm(Encounters ~ government + investor, data = dat)), 4) %>%
  mutate(Model = "Ownership")

### Urban_Rural
tidy_Urban_Rural <- round_df(broom::tidy(lm(Encounters ~ rural, data = dat)), 4) %>%
  mutate(Model = "Urban_Rural")

### LicensedBedSize
tidy_LicensedBedSize <- round_df(broom::tidy(lm(Encounters ~ ordered_LicensedBedSize, data = dat)), 4) %>%
  mutate(Model = "LicensedBedSize")

# Combine all tidied summaries into one table
combined_table <- bind_rows(tidy_ed_visit, tidy_Ownership, tidy_Urban_Rural, tidy_LicensedBedSize)

# Output the table
knitr::kable(combined_table)
```
**Description**

* **EncounterType Model**: The increase in the number of encounters for each additional emergency department visit. It is highly significant (p < 0.0001), suggesting a strong relationship between emergency department visits and the number of encounters.
* **Ownership Model**: The differences in the number of encounters for government-owned and investor-owned facilities compared to the Non-Profit facilities. Both coefficients are significant (p < 0.0001), indicating that ownership type is an important predictor of encounters. 
* **Urban_Rural Model**: The difference in the number of encounters between Rural/Frontier and Urban facilities. The negative coefficient suggests that Rural/Frontier facilities have fewer encounters than urban ones, and this is highly significant (p < 0.0001).
* **LicensedBedSize Model**: Coefficients (L, Q, C, ^4) represent the linear, quadratic, cubic, and quartic terms in a polynomial regression model for ordered bed sizes. The 'L' term has a highly significant positive coefficient, indicating an initial increase in encounters with bed size. However, the lack of significance in the cubic ('C') terms, and the non-significant quadratic ('Q') and quartic term ('^4'), suggests that the relationship might not be strongly non-linear or that there is insufficient data to detect higher-order non-linearities.


## Correlation Matrix
Since `ordered_LicensedBedSize` is ordinal data, we use Spearman correlation coefficients when constructing correlation matrix.
```{r,message=FALSE}
dat1 <- dat %>%
  mutate(ordered_LicensedBedSize = as.numeric(ordered_LicensedBedSize)) %>%
  dplyr::select(ed_visit, government, investor, rural, ordered_LicensedBedSize, Encounters)

correlation_matrix <- cor(dat1, method = "spearman", use = "complete.obs")

# Visualize
corrplot(correlation_matrix, method = "color", addCoef.col = "black", tl.col = "black", tl.srt = 45, insig = "blank" , number.cex = 0.7, diag = FALSE)
```

**Description**

* the variable `ordered_LicensedBedSize` seems to have a moderately positive correlation with `Encounters` (0.41), suggesting that facilities with more licensed beds tend to have more encounters.
* rural has a strong negative correlation with `ordered_LicensedBedSize` (-0.45), implying that rural facilities are likely to have fewer licensed beds.
* Correlation between all variables are below 70%, indicating that it is less likely that collinearity will pose a problem for the regression model.

## Yeo-Johnson transformation
Since `Encounters` can be 0, use Yeo-Johnson transformation instead of Box-Cox transformation.
```{r,fig.width = 9, fig.height = 6,out.width= "60%", fig.align = 'center'}
# Shift the response variable to ensure all values are positive
shift_constant <- abs(min(dat$Encounters)) + 1  # Ensure the minimum value is at least 1
dat$Encounters_shifted <- dat$Encounters + shift_constant

# Fit the model with the shifted response variable
fit2_shifted <- lm(Encounters_shifted ~ ed_visit + government + investor + rural + ordered_LicensedBedSize, data = dat)

# Apply Box-Cox transformation on the shifted response variable
bc_shifted <- MASS::boxcox(fit2_shifted, lambda = seq(-2, 2, by = 0.1))
```

Yeo-Johnson method applies a transformation by raising `Encounters_shifted` to different power, as we can see above, $\lambda$ is close to 0, so we need to do natural logarithm transformation, turn `Encounters_shifted` into ln(`Encounters_shifted`).


## Multivariable Regression Model

```{r}
dat = dat %>%
  mutate(ln_Encounters = log(Encounters_shifted, base = exp(1)))
model = round_df(broom::tidy(lm(ln_Encounters ~  ed_visit+government + investor+rural+ordered_LicensedBedSize, data = dat)) ,4)
fit= lm(ln_Encounters ~  ed_visit+government + investor+rural+ordered_LicensedBedSize, data = dat)

knitr::kable(model)
```

**Description**

* **Coefficients**:
  * `ed_visit`: This predictor has a positive estimated coefficient of 1.2819, suggesting that there is a positive association between ed_visit and the response variable. Given the p-value is practically zero, this relationship is statistically significant.
  * `government`: The positive coefficient of 0.2311 for government implies a positive effect on the response variable, which is statistically significant based on the p-value.
  * `investor`: This predictor has a negative coefficient of -0.1235, suggesting a negative association with the response variable. The p-value indicates this effect is statistically significant, although it is less significant than some other predictors given the higher (but still <0.05) p-value.
  * `rural`: The coefficient of -0.9272 indicates a strong negative relationship with the response variable, and the p-value confirms that this relationship is statistically significant.
  * `ordered_LicensedBedSize.L` (Linear term): The positive coefficient of 1.4611 for this term suggests a significant positive linear trend related to ordered_LicensedBedSize and the response variable.
  * `ordered_LicensedBedSize.Q` (Quadratic term): The negative coefficient of -0.4487 suggests that the relationship between ordered_LicensedBedSize and the response variable has a significant quadratic component, indicating a curved relationship.
  * `ordered_LicensedBedSize.C` (Cubic term): The cubic term has a positive coefficient of 0.2347 and a statistically significant p-value, indicating a cubic relationship is present.
  * `ordered_LicensedBedSize^4`: The fourth-degree polynomial term is not statistically significant (p-value 0.2121) and has a small estimated effect (0.0518), suggesting that it may not be a useful predictor in the model.
* Model Fit: The Multiple R-squared value of 0.2684 suggests that approximately 26.84% of the variability in Encounters is explained by the model.

## Model diagnostics
```{r, fig.align= "center"}
par(mfrow = c(2,2))
plot(fit)
```

**Description**

* The "Residuals vs Fitted" plot shows a funnel-like shape, suggesting potential heteroscedasticity.
* The "Normal Q-Q" plot has deviations from normality, especially in the tails.
* The "Scale-Location" plot shows some signs of heteroscedasticity as the spread of residuals increases with the fitted values.
* The "Residuals vs Leverage" plot indicates a few points with high leverage, but without knowing the Cook's distance threshold, it's unclear if these are problematic.
